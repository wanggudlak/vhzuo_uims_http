- # 总体可行性

  目前，由于结算系统与微桌任务系统存在越来越多的基于用户的拓展需求，两个系统都有共同的用户类型，都是基于这些相同的用户类型展开的业务，故提出开发一个微服务系统，对结算系统及微桌任务系统提供用户及权限认证相关的API服务，并且以后对于用户相关的扩展需求都在这个系统实现。

  这个微服务系统可以命名为：**微桌用户及权限统一认证管理系统**，以下简称***VIIDESK-UIMS***，其中UIMS是Unified Identity Management System的首字母。


- # 用户系统 VIIDESK-UIMS介绍

  1、主要关注四个方面，即4A管理：

  ​	集中账号管理（Account）

  ​	集中认证管理（Authentication）

  ​	集中授权管理（Authorization）

  ​	集中审计管理（Audit）

  2、VIIDESK-UIMS是微桌相关业务系统整个平台账号和权限管控的基础性系统，平台下所有系统的账户管理、身份认证、用户授权、权限控制等行为都必须经由该系统处理，提供帐号密码管理、基本资料管理、角色权限管理等功能。

  UIMS 基于『统一身份治理』的概念，可划分为两级账户体系、基础权限模块和基础信息模块三大模块。其中两级账户体系将账户分为组织实体帐号和个人实体账户两大类，个人实体从属于组织实体，也可以不从属任何组织实体，且个人实体可同时从属于多个组织实体；基础权限模块将各业务系统的资源权限进行统一管理和授权；基础信息模块用于描述组织实体和个人实体的基本信息，如组织实体名称、地址、法人，个人实体姓名、电话号码、性别等基础信息。UIMS 提供统一的 API 与各子系统连接。

  3、就目前而言，微桌任务系统以及微桌结算系统的用户体系都是一级体系，还未涉及二级账户体系，故VIIDESK-UIMS的第一版开发只涉及一级账户体系，但需要留出可扩展的余地。

  从整个平台的角度来看，UIMS 除了提供上述功能和服务，还应该满足以下需求：

- | 编号   | 需求                                 | 描述                              |
  | ---- | ---------------------------------- | ------------------------------- |
  | 1    | 软件授权（暂无）                           | 云平台付费授权机制，可按时间、功能、数量等进行付费授权（暂无） |
  | 2    | 组织入驻 （目前采用脚本自动创建）                  | 允许组织主动申请加入平台（暂无）                |
  | 3    | 实名认证（目前暂无）                         | 个人实名认证、组织实名认证                   |
  | 4    | 资质审核（暂无）                           | 个人和组织的资质审核，如对获得的证书或荣誉进行审核（暂无）   |
  | 5    | 组织绑定（目前是程序自动绑定）                    | 个人账户绑定组织，与组织建立关联关系（暂无）          |
  | 6    | 组织解绑（目前暂无）                         | 个人账户与组织进行解绑（暂无）                 |
  | 7    | 账户注销                               | 个人账户注销，并销毁所有个人资料和档案             |
  | 8    | 统一登录                               | 即 SSO                           |
  | 9    | 统一注册                               | 提供统一或定制的用户注册页面                  |
  | 10   | 角色管理                               |                                 |
  | 11   | 权限资源的管理（包含基本权限资源【菜单、按钮、页面等等】和数据资源） |                                 |
  | 12   | 权限资源策略组的管理                         | 目前可以预先创建一些权限资源策略组               |
  | 13   | 角色与权限资源策略组的关联管理                    |                                 |
  | 14   | 用户与角色的关联管理                         |                                 |

- ## 因此，从功能的角度可以将 VIIDESK-UIMS 划分为以下模块：

```
1、功能

    客户端系统设置
      客户端系统的资料设置
    
    账户实体管理 
      账户管理
      组织实体管理  (目前暂无)
      组织架构管理 (目前暂无)
      
    
    账户权限管理
      角色管理
      资源权限管理
      权限策略组管理
   	  角色与权限资源策略组的关系管理
  
二）页面

    统一注册页面或定制注册页面 
    统一登录页面或定制登录页面 
   	角色及角色关联权限策略组页面
   	用户及用户关联角色页面
   	客户端业务系统设置页面
    组织入驻页面  (目前暂无)
    组织实名认证页面  (目前暂无)

三）API

    鉴权相关的APIs
    业务相关的APIs
```

## 基本原则

- 个人账户统一原则：个人账户一次注册，全平台通用，类似于全网通行证和 SSO，注册和登录都在 UIMS 进行；
- 业务权限独立原则：每个子系统的权限体系是独立管理的。『个人账户统一原则』明确了账户体系是统一的，但是对于每个子系统而言，每个账户所能使用的功能和服务，所能查看的数据权限是独立维护的，比如 XXX 公司（组织）-研发T3组（用户组）-张三（用户）-研发人员（角色），在 微桌任务系统 中，拥有的资源权限（详见下文），与其在 微桌结算系统 中的所拥有的资源权限肯定是不一致的；
- 组织实体隔离原则：不同的组织实体之间，是相互隔离，独立管理的。每个组织实体可以自行组织自己的组织体系、账户体系和权限体系。不同的组织实体资源权限也是隔离的。（目前暂无）
- 从属关系隔离原则：个体账户与组织实体的从属关系是基于单独的业务系统存在的，『个人账户统一原则』明确的仅是个人账户的全网统一，但组织实体、从属关系并没有统一，并且是隔离的。比如在 微桌结算 系统中，张三（用户）从属于 XXXX 公司（组织），但在微桌任务系统，OA系统中，张三（用户）默认是不从属于任何组织的，从属关系受到具体业务系统的影响。事实上，这个原则是非强制的，具体取决于各自的业务逻辑和业务场景。如果要简化从属关系的管理，那么可以不遵循此原则，即个体账户与组织实体的从属关系是全平台统一的，与业务系统无关，但这会为降低平台的灵活性和扩展性。灵活性和复杂度之间通常要做一个取舍。

## 权限原则

类似于 RBAC 原则，VIIDESK-UIMS平台的权限体系采用 OS-RBAC 的概念：

- OS：O 代表 Organization 组织，S 代表 System 业务系统，即权限是受到组织实体和业务系统双重影响的；

- RBAC：基于角色的访问控制；

- OS-RBAC：组织实体-业务系统-用户-角色-权限标识。分为两种情况：一种是有从属组织的个人账户；另一种是无从属组织的个人账户，后者无组织，但同样遵守 RBAC 的权限限定，且其权限标识体系允许组织为空；

- 资源标识：分为逻辑资源和实体资源。逻辑资源如菜单、页面、表单、按钮组、按钮、字段等功能型资源，或人员档案、考勤记录、任务记录、位置数据、积分、电子钱包等数据资源；实体资源如椅子、凳子、电脑、车辆等实物资产，另外有时候部分逻辑资源也可以归纳为实体资源，如电子照片、视频文件、音乐文件等（目前在我们的微桌结算系统、微桌任务系统中，主要涉及的是逻辑资源，如果以后公司做OA系统，那就要涉及逻辑资源和实体资源了）；

- 条件标识：权限的约束条件，主要有可见组织架构范围限定、时间限定、区域限定等。例如某权限仅财务部可见，有效期至11月2号，这里『财务部』属于可见组织架构范围限定，『至11月2号』则是时间限定；

- 权限标识：用于标识账户实体在指定的条件下拥有访问某项功能、查看某些数据的权限。资源标识和条件标识与权限标识关联，权限标识与角色关联，角色与用户关联。例如张三（用户）-研发人员（角色）-拥有『研发部』所有人员档案的增上改查权限；

- 业务系统标识符：受『业务权限独立原则』的约束，与传统的资源权限有所不同的是，所有权限标识都与具体的业务系统关联，例如企业微桌结算系统就是一个业务系统，具体的权限标识与业务系统有直接的关系，例如菜单、表单、页面、按钮、图片等资源；

- 权限策略组：权限策略组是在 OS-RBAC 基础上设置的，为简化权限配置的一种辅助手段，在实际应用中可以不创建策略组。策略组分为平台级策略组和业务系统级别的策略组，两种策略组的作用域仅限于相同组织实体内部，但对于无从属组织的个人账户除外。策略组与角色类似，可以将资源权限绑定到策略组中，但不同之处是，平台级策略组可以横跨业务系统进行平台级的资源权限绑定。因为账户体系跨越多个子系统，在遵循『业务权限独立原则』的限定下，每个子系统都需要做一套权限配置，操作上较为繁琐，因此充分运用策略组可以大大简化权限配置工作。平台可以内置多套常用的策略组，终端用户可以直接选用策略组，也可以基于某个策略组为基础，进行修改。值得注意的是，策略组的作用域仅限于相同组织实体内部，即策略组可以横跨业务系统，但不能同时作用于多个组织实体；（第一版暂不支持策略组，但需要留下可扩展的余地）

- VIIDESK-UIMS平台采用多角色权限并集的设计：

  ![RBAC模型](https://upload-images.jianshu.io/upload_images/1603917-f09fcc47a060f670.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/489 "RBAC模型")

## 从属关系梳理

> 为简单起见，我们将不遵守『从属关系隔离原则』，即用户实体与组织实体的从属关系与业务系统无关。系统涉及的实体类型有：

- 业务系统（系统标识）
- 服务账户（客户端）
- 个人账户实体
- 组织账户实体（目前没有，我们可以预留设置一个组织实体）
- 组织架构（目前没有，可以留有扩展余地）
- 用户组（非必选项）
- 角色实体
- 权限实体
- 资源实体
- 限定条件实体
- 权限策略组（非必选项）

1、与组织实体强关联的实体

>基于『组织实体隔离原则』，这类实体类型不能脱离组织实体独立存在。

- 组织架构
- 角色实体
- 权限实体
- 资源实体
- 限定条件实体

>由于组织架构不能脱离组织实体单独存在，因此当用户实体绑定组织架构时，该用户实体必须隶属于该组织架构所从属的组织实体。同理可知以下从属关系遵从同样的约束——即每对关系的两个实体对象必须属于相同的组织实体

- 用户与角色
- 角色与权限
- 资源与权限
- 限定条件与权限

2、 与业务系统强关联的实体

>基于『业务系统隔离原则』，这类实体类型不能脱离业务系统独立存在。

- 权限实体
- 资源实体
- 限定条件实体

3、实体类型

​	基于以上各项原则，实体类型又分为以下几种情况：

- 组织实体（未认证）：在组织实体的模式下，可以按照组织的管理要求，独立设置一套组织架构、账户和数据权限体系，比如设置下属企业、分公司、部门、岗位职务、角色权限，组织实体缺省分配一个管理员帐户，拥有全部权限，由管理员初始化配置信息；
- 组织实体（已认证）：拥有未认证组织实体的所有权利，但已认证的实体通常拥有更多的配额，更少的功能限制，此外有些特定的业务功能和业务流程，必须是实名认证的实体才能使用，比如支付和交易。
- 个人实体（未认证）：在个人实体的模式下，享受的权利由具体的业务系统决定，原则上个人实体作为独立的账户类型，应该享有基本的功能权限和数据权限，如个人中心的各项功能等。
- 个人实体（已认证）：与组织实体（已认证）类似。
- 个人实体（未从属于组织）：未从属组织的个人实体账户，与上述个人实体类型一致。
- 个人实体（从属单个组织）：从属单个组织的个人实体账户，除了具备个人实体账户的原本权利外，还受到组织权限的约束，原本个人实体不享受的权利，可能现在可以享受，原本享受的权利，可能现在不可以享受了。
- 个人实体（从属多个组织）：当个人实体账户从属于多个组织时，除了个人账户原本拥有的权利外，所从属的组织所带来的权利须遵循『组织实体隔离原则』，且受到『从属关系隔离原则』的约束，具体的权利配置由各个业务系统独立管理。这里有两种情况：一是在用户登录时，必须选择所属的组织机构，类似于 LOL 游戏，在登录时须选择所属的区域和服务器；二是在用户登录后，可以自由选择组织实体，类似于阿里云或华为云的区域选择，在用户未选择所属组织时，应当按照未从属于组织的个人实体账户对待。
- 组织管理员：组织管理员拥有该组织内部的全部资源权限，例如可以创建个人账户，在个人未完成首次登录前，可以删除（解雇），修改，在个人完成登录后，则权限移交给了个人；删除（解雇）时，只是个人脱离组织，个人不再拥有组织员工的权限，在组织内的个人工作经历仍然保留，组织清除离职员工，则这些在职经历将不为企业可管理，但个人自己可见，不可变更。

4、用户分类

|      | 结算系统                                     | 微桌任务系统                 |
| ---- | ---------------------------------------- | ---------------------- |
| 用户   | 商户或需求方、自由职业者或服务方、结算公司、经纪公司               | 用户                     |
| 角色   | 前台角色：财务经理、操作员； 后台角色：超级管理员、管理员、财务经理、财务助理、开票主管、客服 | 包含需求方、服务方（普通服务方、RPO服务方 |

上表中，微桌任务系统中的用户是一个统一抽象的概念，包含需求方、服务方，需求方和结算系统的商户是相同的概念，即可以认为是同一类用户；微桌任务系统中的服务方包含普通服务方，即自由职业者，和RPO服务方，与结算系统中的自由职业者是同一类用户；需要注意的是，结算系统中的商户对于微桌任务系统来说，既可以是需求方，也可以是服务方；

5、组织分类

>目前我们不涉及组织，但是为了考虑可扩展性，我们在1.0版这样设置组织：
>
>商户或需求方注册时，以商户名默认生成一个组织；
>
>自由职业者或服务方注册时，以自由职业者名称默认生成一个组织

## 基础信息模块

1. ##  EAV 数据模型

   EAV 即 Entity（实体）-Attribute（属性）-Value（值）数据模型，将传统的 ORM 映射模型——即实体属性与数据库表字段一一对应的模型，变换为实体属性与数据表的行记录一一对应的模型。EAV 模型大大增加了数据映射和相关业务逻辑的复杂程度，但是具备高度的灵活性，能够满足随时变化的信息结构，满足动态变更的实体结构、满足字段级权限控制、满足字段级数据版本历史等功能。

2. ## 采用松散型数据结构的数据库方案

   其中的代表便是 MongoDB：一个介于关系数据库和非关系数据库之间的分布式文件存储数据库产品，在 CAP 理论中属于 CP 范畴，支持松散数据结构，支持复杂的混合数据类型，支持 JSON 和文档存储。采用此方案的优势比较明显，除了能够满足 EAV 模型所具备的大部分功能外，还大大简化了技术复杂度，支持分布式部署，推荐采用此方案。

3. ## 信息分类

   平台的信息主要分为基础信息和业务信息两大类。基础信息分为个人实体信息和组织实体信息，主要描述实体的基本信息、通用信息，与业务相关性不大，例如姓名、性别、身份证号码、手机号码、企业通用信息、企业工商信息等。业务信息由各业务系统自行管理和维护，UIMS 不涉及。

   | 实体类别 | 信息类别 | 信息范围                                     | 备注         |
   | ---- | ---- | ---------------------------------------- | ---------- |
   | 用户信息 | 基础信息 | 昵称、性别                                    | 默认公开       |
   | 用户信息 | 基础信息 | 身份证信息、籍贯、性别、出生日期、学历、工作履历、电话号码、通信地址、照片、银行卡号 | 须用户授权收集和公开 |
   | 用户信息 | 业务信息 | 用户移动终端的设备信息，包括IP地址、Mac地址、操作系统信息、设备型号、识别码等 | 须用户授权收集和公开 |
   | 用户信息 | 业务信息 | 用户的行为信息，包括操作记录，cookies，通过平台编辑或传送的文字、图片、语音或视频信息等 | 须用户授权收集和公开 |
   | 用户信息 | 业务信息 | 用户喜好、特长、手工标签、自动标签、社交互动信息等                | 须用户授权收集和公开 |
   |      |      |                                          |            |
   |      |      |                                          |            |
   |      |      |                                          |            |

 4、总体来说，VIIDESK-UIMS系统要做的事情有这么几件：

​	

- 定义实体

  业务系统实体

  服务账户实体（客户端）

  组织实体

  组织架构

  个人实体

  角色实体

  权限标识

  资源标识

  条件标识

处理上述各实体之间的关系，并提供数据结构

提供鉴权 APIs 和业务 APIs

提供其他功能：统一注册功能（页面和流程）、统一登录功能。

- # VIIDESK-UIMS数据库结构设计

  ​

  ​